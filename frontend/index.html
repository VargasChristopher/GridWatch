<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Welcome to GridWatch</title>
    <meta
      name="description"
      content="GridWatch — an agentic city management system. Search U.S. cities and prepare for future features like alerts and heatmaps."
    />
    <style>
      /* ===============
       Design tokens
       =============== */
      :root {
        --bg: #0f1220;
        --panel: #171a2b;
        --panel-2: #1f2340;
        --border: #2a2f55;
        --muted: #9aa3b2;
        --text: #e8ebf4;
        --accent: #7aa8ff;
        --accent-2: #4ce1b6;
        --focus: 0 0 0 3px rgba(122, 168, 255, 0.35);
        --radius: 14px;
        --shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #1a1f3d,
            transparent
          ),
          var(--bg);
        color: var(--text);
      }

      /* ======= Layout */
      .app {
        max-width: 1080px;
        margin: 0 auto;
        padding: 28px 20px 48px;
      }
      header.hero {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 6px 0 18px;
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: var(--shadow);
        display: grid;
        place-items: center;
        font-weight: 700;
        color: #0b1020;
      }
      .title-wrap h1 {
        margin: 0;
        font-size: clamp(22px, 3vw, 34px);
        letter-spacing: 0.2px;
      }
      .title-wrap p {
        margin: 0.25rem 0 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 22px;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      /* ======= Search Card */
      .search-card {
        padding: 14px;
      }
      .input-wrap {
        position: relative;
      }
      .input-wrap svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
      }
      #citySearch {
        width: 100%;
        padding: 14px 14px 14px 40px;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
        background: #0d1022;
        color: var(--text);
        font-size: 16px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      }
      #citySearch:focus {
        box-shadow: var(--focus);
      }

      .results {
        margin-top: 10px;
        height: 360px;
        overflow: auto;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #0d1022;
      }
      /* Custom scrollbars */
      .results::-webkit-scrollbar {
        width: 12px;
      }
      .results::-webkit-scrollbar-track {
        background: #0f1430;
        border-left: 1px solid var(--border);
      }
      .results::-webkit-scrollbar-thumb {
        background: #2b315f;
        border: 2px solid #0f1430;
        border-radius: 10px;
      }

      .option {
        padding: 12px 14px;
        border-bottom: 1px solid #181c36;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .option:hover,
      .option[aria-selected="true"] {
        background: #151a36;
      }
      .option:last-child {
        border-bottom: none;
      }
      .option .badge {
        margin-left: auto;
        background: #1e2447;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      mark {
        background: rgba(122, 168, 255, 0.2);
        color: inherit;
        padding: 0 2px;
        border-radius: 3px;
      }

      .meta {
        padding: 16px;
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--muted);
        font-size: 12px;
      }

      /* ======= Detail / Future Modules */
      .detail {
        padding: 16px 16px 6px;
        display: grid;
        gap: 14px;
      }
      .card {
        background: #0d1022;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }
      .empty {
        color: var(--muted);
        font-style: italic;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #0f1430;
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .footer {
        margin-top: 16px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        border: 1px solid var(--border);
        padding: 2px 6px;
        border-radius: 6px;
        background: #0f1430;
      }
      /* Buttons + utility */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b1020;
        box-shadow: var(--shadow);
      }
      .btn:focus {
        outline: none;
        box-shadow: var(--focus);
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <header class="hero">
        <div class="logo" aria-hidden="true">GW</div>
        <div class="title-wrap">
          <h1>Welcome to GridWatch</h1>
          <p>Search a city to begin.</p>
        </div>
      </header>

      <main>
        <!-- Left: Search / City Picker -->
        <section class="panel search-card" aria-labelledby="searchLabel">
          <h2 id="searchLabel" style="position: absolute; left: -9999px">
            Search U.S. Cities
          </h2>

          <div
            class="input-wrap"
            role="combobox"
            aria-expanded="true"
            aria-owns="resultsList"
            aria-haspopup="listbox"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              id="citySearch"
              type="search"
              placeholder="Search Cities"
              autocomplete="off"
              aria-autocomplete="list"
              aria-controls="resultsList"
              aria-activedescendant=""
            />
          </div>

          <div
            id="results"
            class="results"
            role="listbox"
            aria-label="City results"
          >
            <!-- JS inserts results here -->
          </div>
          <div class="meta">
            <span id="resultCount">Type to filter cities</span>
            <button id="viewBtn" class="btn hidden">View</button>
            <span
              >Tip: Use <span class="kbd">↑</span>
              <span class="kbd">↓</span> then
              <span class="kbd">Enter</span></span
            >
          </div>
        </section>
      </main>
    </div>

    <script>
      // ========== Core ==========
      class EventBus {
        constructor() {
          this.events = Object.create(null);
        }
        on(evt, h) {
          (this.events[evt] ||= []).push(h);
          return () => this.off(evt, h);
        }
        off(evt, h) {
          this.events[evt] = (this.events[evt] || []).filter((x) => x !== h);
        }
        emit(evt, payload) {
          (this.events[evt] || []).forEach((h) => h(payload));
        }
      }

      const app = {
        bus: new EventBus(),
        store: { query: "", selectedCity: null, cities: [] },
        use(p) {
          p({ bus: this.bus, store: this.store });
        },
        setQuery(q) {
          this.store.query = q;
          this.bus.emit("query:changed", q);
        },
        selectCity(city) {
          this.store.selectedCity = city;
          localStorage.setItem("gw:selected", JSON.stringify(city));
          this.bus.emit("city:selected", city);
        },
      };

      // ========== Data ==========
      const FALLBACK_CITIES = [
        "New York, NY",
        "Los Angeles, CA",
        "Chicago, IL",
        "Houston, TX",
        "Phoenix, AZ",
        "Philadelphia, PA",
        "San Antonio, TX",
        "San Diego, CA",
        "Dallas, TX",
        "San Jose, CA",
        "Austin, TX",
        "Jacksonville, FL",
        "Fort Worth, TX",
        "Columbus, OH",
        "Charlotte, NC",
        "San Francisco, CA",
        "Indianapolis, IN",
        "Seattle, WA",
        "Denver, CO",
        "Washington, DC",
        "Boston, MA",
        "Nashville, TN",
        "El Paso, TX",
        "Detroit, MI",
        "Portland, OR",
        "Memphis, TN",
        "Oklahoma City, OK",
        "Las Vegas, NV",
        "Louisville, KY",
        "Baltimore, MD",
        "Milwaukee, WI",
        "Albuquerque, NM",
        "Tucson, AZ",
        "Fresno, CA",
        "Mesa, AZ",
        "Sacramento, CA",
        "Kansas City, MO",
        "Atlanta, GA",
        "Miami, FL",
        "Colorado Springs, CO",
        "Raleigh, NC",
        "Omaha, NE",
        "Long Beach, CA",
        "Virginia Beach, VA",
        "Oakland, CA",
        "Minneapolis, MN",
        "Tulsa, OK",
        "Tampa, FL",
        "Arlington, TX",
        "New Orleans, LA",
        "Wichita, KS",
        "Bakersfield, CA",
        "Cleveland, OH",
        "Aurora, CO",
        "Anaheim, CA",
        "Honolulu, HI",
        "Santa Ana, CA",
        "Riverside, CA",
        "Corpus Christi, TX",
        "Lexington, KY",
        "Henderson, NV",
        "Stockton, CA",
        "St. Paul, MN",
        "St. Louis, MO",
        "Pittsburgh, PA",
        "Cincinnati, OH",
        "Anchorage, AK",
        "Greensboro, NC",
        "Plano, TX",
        "Newark, NJ",
        "Lincoln, NE",
        "Orlando, FL",
        "Irvine, CA",
        "Toledo, OH",
        "Durham, NC",
        "Chula Vista, CA",
        "Fort Wayne, IN",
        "Jersey City, NJ",
        "St. Petersburg, FL",
        "Laredo, TX",
        "Madison, WI",
        "Chandler, AZ",
        "Buffalo, NY",
        "Lubbock, TX",
        "Scottsdale, AZ",
        "Reno, NV",
        "Glendale, AZ",
        "Gilbert, AZ",
        "Winston-Salem, NC",
        "North Las Vegas, NV",
        "Norfolk, VA",
        "Chesapeake, VA",
        "Garland, TX",
        "Irving, TX",
        "Hialeah, FL",
        "Fremont, CA",
        "Boise, ID",
        "Richmond, VA",
        "Spokane, WA",
        "Baton Rouge, LA",
        "Tacoma, WA",
        "San Bernardino, CA",
        "Modesto, CA",
        "Fontana, CA",
        "Santa Clarita, CA",
        "Des Moines, IA",
        "Birmingham, AL",
        "Rochester, NY",
      ];

      async function loadCities() {
        try {
          const res = await fetch("data/cities.json", { cache: "no-store" });
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data) && data.length) return data;
          }
        } catch {}
        return FALLBACK_CITIES;
      }

      // ========== Utils ==========
      const $ = (s, r = document) => r.querySelector(s);
      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }
      function highlight(txt, term) {
        if (!term) return txt;
        try {
          return txt.replace(
            new RegExp(escapeRegExp(term), "ig"),
            (m) => `<mark>${m}</mark>`
          );
        } catch {
          return txt;
        }
      }

      // ========== Search + selection UI ==========
      app.use(({ bus, store }) => {
        const input = $("#citySearch");
        const listEl = $("#results");
        const countEl = $("#resultCount");
        const viewBtn = $("#viewBtn");

        let activeIndex = -1;
        let filtered = [];

        function render() {
          const q = store.query.trim().toLowerCase();
          filtered = !q
            ? store.cities.slice(0, 200)
            : store.cities.filter((c) => c.toLowerCase().includes(q));
          listEl.innerHTML = filtered
            .map((c, i) => {
              const isActive = i === activeIndex;
              const isSelected =
                store.selectedCity && c === store.selectedCity.name;
              return `
          <div class="option" id="opt-${i}" role="option"
               aria-selected="${isActive || isSelected}" data-idx="${i}">
            <span class="dot" aria-hidden="true">🏙️</span>
            <span class="label">${highlight(c, store.query)}</span>
            <span class="badge">US</span>
          </div>`;
            })
            .join("");
          countEl.textContent = filtered.length
            ? `${filtered.length} result${filtered.length === 1 ? "" : "s"}`
            : "No matches";
          input.setAttribute(
            "aria-activedescendant",
            activeIndex >= 0 ? `opt-${activeIndex}` : ""
          );
        }

        function move(delta) {
          if (!filtered.length) return;
          activeIndex =
            (activeIndex + delta + filtered.length) % filtered.length;
          render();
          const activeEl = document.getElementById(`opt-${activeIndex}`);
          if (activeEl) {
            activeEl.scrollIntoView({ block: "nearest" });
          }
        }

        function selectByIndex(i) {
          const city = filtered[i];
          if (city) {
            activeIndex = i; // keeps highlight in sync for mouse or keyboard
            app.selectCity({ name: city }); // triggers button visibility handler
            render();
          }
        }

        input.addEventListener("input", (e) => {
          activeIndex = -1;
          app.setQuery(e.target.value);
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            move(1);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            move(-1);
          } else if (e.key === "Enter" && activeIndex >= 0) {
            e.preventDefault();
            selectByIndex(activeIndex);
          }
        });
        listEl.addEventListener("click", (e) => {
          const opt = e.target.closest(".option");
          if (!opt) return;
          selectByIndex(parseInt(opt.dataset.idx, 10));
        });

        // Show/hide + wire the View button after a selection
        bus.on("city:selected", (city) => {
          if (!viewBtn) return;
          if (city && city.name) {
            viewBtn.classList.remove("hidden");
            viewBtn.onclick = () => {
              const url = `city.html?name=${encodeURIComponent(city.name)}`;
              window.location.href = url; // same tab
            };
          } else {
            viewBtn.classList.add("hidden");
            viewBtn.onclick = null;
          }
        });

        bus.on("query:changed", render);
        bus.on("cities:loaded", render);

        // Ensure nothing is pre-selected on first load:
        localStorage.removeItem("gw:selected");
      });

      // ========== Boot ==========
      (async function init() {
        const cities = await loadCities();
        app.store.cities = cities;
        app.bus.emit("cities:loaded", cities);
      })();
    </script>
  </body>
</html>

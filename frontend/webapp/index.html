<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>GridWatch</title>
    <link rel="icon" href="/logo.ico" sizes="any" />
    <meta
      name="description"
      content="GridWatch — an agentic city management system. Search U.S. cities and prepare for future features like alerts and heatmaps."
    />
    <style>
      /* ===============
       Design tokens
       =============== */
      :root {
        --bg: #f6f7f8;
        --panel: #ffffff;
        --panel-2: #f2f2f2;
        --border: #d9d9d9;
        --muted: #6b6b6b;
        --text: #111111;
        --accent: #bdbdbd;
        --accent-2: #7a7a7a;
        --focus: 0 0 0 3px rgba(0, 0, 0, 0.18);
        --radius: 14px;
        --shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #1a1a1a,
            transparent
          ),
          var(--bg);
        color: var(--text);
      }

      /* ======= Layout */
      .app {
        max-width: 1080px;
        margin: 0 auto;
        padding: 28px 20px 48px;

        /* Center the whole block (header + search) in the viewport */
        min-height: 100svh; /* use full viewport height */
        display: flex;
        flex-direction: column;
        align-items: center; /* horizontal center */
        justify-content: center; /* vertical center */
        gap: 24px; /* space between header and search */
      }

      header.hero {
        display: flex;
        align-items: center;
        justify-content: center; /* center header content */
        gap: 16px;
        margin: 6px 0 18px;
        text-align: center; /* center text inside title-wrap */
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        box-shadow: var(--shadow);
        /* Show the provided grid image inside the same 40×40 square */
        background-image: url("/Grid.png");
        background-size: cover; /* fill the square, crop overflow */
        background-position: center; /* center the image */
        background-repeat: no-repeat;
        display: block;
      }

      .title-wrap h1 {
        margin: 0;
        font-size: clamp(22px, 3vw, 34px);
        letter-spacing: 0.2px;
      }
      .title-wrap p {
        margin: 0.25rem 0 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        /* Center the search card itself */
        display: grid;
        grid-template-columns: 1fr; /* single column */
        place-items: center; /* center horizontally + vertically inside main */
        width: 100%;
      }

      .panel {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      /* ======= Search Card */
      .search-card {
        padding: 14px;
        width: min(640px, 92vw);
      }
      .input-wrap {
        position: relative;
      }
      .input-wrap svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
      }
      #citySearch {
        width: 100%;
        padding: 14px 14px 14px 40px;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
        background: #111111;
        color: var(--text);
        font-size: 16px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      }
      #citySearch:focus {
        box-shadow: var(--focus);
      }

      .results {
        margin-top: 10px;
        height: 360px;
        overflow: auto;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #111111;
      }
      /* Custom scrollbars */
      .results::-webkit-scrollbar {
        width: 12px;
      }
      .results::-webkit-scrollbar-track {
        background: #141414;
        border-left: 1px solid var(--border);
      }
      .results::-webkit-scrollbar-thumb {
        background: #343434;
        border: 2px solid #141414;
        border-radius: 10px;
      }

      .option {
        padding: 12px 14px;
        border-bottom: 1px solid #262626;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .option:hover,
      .option[aria-selected="true"] {
        background: #1b1b1b;
      }
      .option:last-child {
        border-bottom: none;
      }
      .option .badge {
        margin-left: auto;
        background: #2a2a2a;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      mark {
        background: rgba(122, 168, 255, 0.2);
        color: inherit;
        padding: 0 2px;
        border-radius: 3px;
      }

      .meta {
        padding: 16px;
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--muted);
        font-size: 12px;
      }

      /* ======= Detail / Future Modules */
      .detail {
        padding: 16px 16px 6px;
        display: grid;
        gap: 14px;
      }
      .card {
        background: #111111;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }
      .empty {
        color: var(--muted);
        font-style: italic;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #141414;
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .footer {
        margin-top: 16px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        border: 1px solid var(--border);
        padding: 2px 6px;
        border-radius: 6px;
        background: #141414;
      }
      /* Buttons + utility */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b1020;
        box-shadow: var(--shadow);
      }
      .btn:focus {
        outline: none;
        box-shadow: var(--focus);
      }
      .hidden {
        display: none !important;
      }
      /* Smaller pill button */
      .btn.small {
        padding: 6px 10px;
        font-size: 12px;
      }

      /* Per-row View button is hidden until the row is selected (or hovered) */
      .option .view-btn {
        display: none;
        margin-right: 6px;
      }
      .option[aria-selected="true"] .view-btn,
      .option:hover .view-btn {
        display: inline-flex;
      }

      /* Hide the footer View button since we’re moving it inline */
      #viewBtn {
        display: none !important;
      }
      .option {
        display: flex;
        align-items: center;
      }
      .option .label {
        flex: 1;
      }
      /* ===== THEME FOUNDATION (add at end) ===== */
      :root {
        /* Tell UA we support both schemes */
        color-scheme: light dark;

        /* Light defaults */
        --bg: #f6f7f8;
        --panel: #ffffff;
        --panel-2: #f2f2f2;
        --border: #d9d9d9;
        --muted: #6b6b6b;
        --text: #111111;
        --accent: #bdbdbd;
        --accent-2: #7a7a7a;
        --focus: 0 0 0 3px rgba(0, 0, 0, 0.18);
        --radius: 14px;
        --shadow: 0 6px 24px rgba(0, 0, 0, 0.08);

        /* Additional tokens for places that were hard-coded */
        --card: #ffffff;
        --field: #ffffff;
        --hover: #f5f5f5;
        --line: #e7e7e7;
        --chip-bg: #f2f2f2;
        --scroll-track: #f0f0f0;
        --scroll-thumb: #cccccc;
      }

      /* Dark overrides mirror your current design */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0b0c;
          --panel: #121212;
          --panel-2: #1a1a1a;
          --border: #2a2a2a;
          --muted: #9a9a9a;
          --text: #f3f3f3;
          --shadow: 0 8px 30px rgba(0, 0, 0, 0.35);

          --card: #111111;
          --field: #111111;
          --hover: #1b1b1b;
          --line: #262626;
          --chip-bg: #161616;
          --scroll-track: #141414;
          --scroll-thumb: #343434;
        }
      }

      /* Use variables to override earlier hard-coded colors (no markup changes) */
      body {
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #1a1a1a,
            transparent
          ),
          var(--bg);
        color: var(--text);
      }
      @media (prefers-color-scheme: dark) {
        body {
          background: radial-gradient(
              1200px 600px at 10% -10%,
              #1a1a1a,
              transparent
            ),
            var(--bg);
        }
      }

      .panel {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--border);
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
      }
      #citySearch {
        background: var(--field);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .results {
        background: var(--card);
        border: 1px solid var(--border);
      }
      .option {
        border-bottom: 1px solid var(--line);
      }
      .option:hover,
      .option[aria-selected="true"] {
        background: var(--hover);
      }
      .option .badge {
        background: var(--chip-bg);
        color: var(--muted);
      }
      .tag,
      .kbd {
        background: var(--chip-bg);
        border: 1px solid var(--border);
        color: var(--muted);
      }

      /* Scrollbar colors */
      .results::-webkit-scrollbar-track {
        background: var(--scroll-track);
        border-left: 1px solid var(--border);
      }
      .results::-webkit-scrollbar-thumb {
        background: var(--scroll-thumb);
        border: 2px solid var(--scroll-track);
        border-radius: 10px;
      }
      /* === faint, underlay grid (light + dark) === */
      :root {
        --grid-size: 24px; /* cell size */
        --grid-major-mult: 4; /* every Nth line is “major” */
        /* lighter alphas for subtle look (light mode) */
        --grid-line: rgba(0, 0, 0, 0.025);
        --grid-major-line: rgba(0, 0, 0, 0.045);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          /* darker theme gets even softer lines */
          --grid-line: rgba(255, 255, 255, 0.02);
          --grid-major-line: rgba(255, 255, 255, 0.04);
        }
      }

      /* create a stacking context so the grid can sit behind everything */
      body {
        position: relative;
        z-index: 0;
      }

      /* draw grid BEHIND content */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -1; /* << key: under all content */
        opacity: 0.5; /* overall strength (lower = subtler) */

        /* minor vertical, minor horizontal, major vertical, major horizontal */
        background-image: repeating-linear-gradient(
            to right,
            var(--grid-line) 0 1px,
            transparent 1px var(--grid-size)
          ),
          repeating-linear-gradient(
            to bottom,
            var(--grid-line) 0 1px,
            transparent 1px var(--grid-size)
          ),
          repeating-linear-gradient(
            to right,
            var(--grid-major-line) 0 1px,
            transparent 1px calc(var(--grid-size) * var(--grid-major-mult))
          ),
          repeating-linear-gradient(
            to bottom,
            var(--grid-major-line) 0 1px,
            transparent 1px calc(var(--grid-size) * var(--grid-major-mult))
          );
        background-attachment: fixed, fixed, fixed, fixed; /* stays put on scroll */
      }

      :root {
        --shadow-soft: 0 1px 4px rgba(0, 0, 0, 0.12);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.22);
        }
      }

      .option .view-btn {
        box-shadow: var(--shadow-soft);
      }
    </style>
    <link rel="preload" as="image" href="/Grid.png" type="image/png" />
    <link
      rel="apple-touch-icon"
      href="/Grid_apple.png"
      sizes="180x180"
      type="image/png"
    />
  </head>
  <body>
    <div class="app" id="app">
      <header class="hero">
        <div class="logo" aria-hidden="true"></div>
        <div class="title-wrap">
          <h1>Welcome to GridWatch</h1>
          <p>Select a city to begin.</p>
        </div>
      </header>

      <main>
        <!-- Search / City Picker -->
        <section class="panel search-card" aria-labelledby="searchLabel">
          <h2 id="searchLabel" style="position: absolute; left: -9999px">
            Search U.S. Cities
          </h2>

          <div
            class="input-wrap"
            role="combobox"
            aria-expanded="true"
            aria-owns="resultsList"
            aria-haspopup="listbox"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              id="citySearch"
              type="search"
              placeholder="Search Cities"
              autocomplete="off"
              aria-autocomplete="list"
              aria-controls="resultsList"
              aria-activedescendant=""
            />
          </div>

          <div
            id="results"
            class="results"
            role="listbox"
            aria-label="City results"
          >
            <!-- JS inserts results here -->
          </div>
          <div class="meta">
            <span id="resultCount">Type to filter cities</span>
            <button id="viewBtn" class="btn hidden">View</button>
            <label
              class="remember"
              for="rememberChoice"
              style="
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <input type="checkbox" id="rememberChoice" />
              Remember choice
            </label>
          </div>
        </section>
      </main>
    </div>

    <script>
      (() => {
        const path = decodeURIComponent(location.pathname).replace(
          /^\/+|\/+$/g,
          ""
        );
        if (!path || /\.[a-z0-9]+$/i.test(path)) return;

        // Match "<any-city-slug>-ST"
        const m = path.match(/^(.+)-([A-Za-z]{2})$/);
        if (!m) return;
        const [, citySlug, st] = m;

        function fromSlug(slug) {
          return slug
            .replace(/--/g, "\u0000") // temp marker for real hyphens
            .replace(/-/g, " ") // hyphens that were spaces
            .replace(/\u0000/g, "-") // restore real hyphens
            .replace(/([a-z])([A-Z])/g, "$1 $2")
            .trim();
        }

        const city = fromSlug(citySlug);
        location.replace(
          `/city.html?name=${encodeURIComponent(
            `${city}, ${st.toUpperCase()}`
          )}`
        );
      })();

      // ========== Core ==========
      class EventBus {
        constructor() {
          this.events = Object.create(null);
        }
        on(evt, h) {
          (this.events[evt] ||= []).push(h);
          return () => this.off(evt, h);
        }
        off(evt, h) {
          this.events[evt] = (this.events[evt] || []).filter((x) => x !== h);
        }
        emit(evt, payload) {
          (this.events[evt] || []).forEach((h) => h(payload));
        }
      }

      const app = {
        bus: new EventBus(),
        store: { query: "", selectedCity: null, cities: [] },
        use(p) {
          p({ bus: this.bus, store: this.store });
        },
        setQuery(q) {
          this.store.query = q;
          this.bus.emit("query:changed", q);
        },
        selectCity(city) {
          this.store.selectedCity = city;
          localStorage.setItem("gw:selected", JSON.stringify(city));
          this.bus.emit("city:selected", city);
        },
      };

      // ========== Data ==========
      const FALLBACK_CITIES = [
        "Washington, DC",
        "Los Angeles, CA",
        "Chicago, IL",
        "Houston, TX",
        "Phoenix, AZ",
        "Philadelphia, PA",
        "San Antonio, TX",
        "San Diego, CA",
        "Dallas, TX",
        "San Jose, CA",
        "Austin, TX",
        "Jacksonville, FL",
        "Fort Worth, TX",
        "Columbus, OH",
        "Charlotte, NC",
        "San Francisco, CA",
        "Indianapolis, IN",
        "Seattle, WA",
        "Denver, CO",
        "New York, NY",
        "Boston, MA",
        "Nashville, TN",
        "El Paso, TX",
        "Detroit, MI",
        "Portland, OR",
        "Memphis, TN",
        "Oklahoma City, OK",
        "Las Vegas, NV",
        "Louisville, KY",
        "Baltimore, MD",
        "Milwaukee, WI",
        "Albuquerque, NM",
        "Tucson, AZ",
        "Fresno, CA",
        "Mesa, AZ",
        "Sacramento, CA",
        "Kansas City, MO",
        "Atlanta, GA",
        "Miami, FL",
        "Colorado Springs, CO",
        "Raleigh, NC",
        "Omaha, NE",
        "Long Beach, CA",
        "Virginia Beach, VA",
        "Oakland, CA",
        "Minneapolis, MN",
        "Tulsa, OK",
        "Tampa, FL",
        "Arlington, TX",
        "New Orleans, LA",
        "Wichita, KS",
        "Bakersfield, CA",
        "Cleveland, OH",
        "Aurora, CO",
        "Anaheim, CA",
        "Honolulu, HI",
        "Santa Ana, CA",
        "Riverside, CA",
        "Corpus Christi, TX",
        "Lexington, KY",
        "Henderson, NV",
        "Stockton, CA",
        "St. Paul, MN",
        "St. Louis, MO",
        "Pittsburgh, PA",
        "Cincinnati, OH",
        "Anchorage, AK",
        "Greensboro, NC",
        "Plano, TX",
        "Newark, NJ",
        "Lincoln, NE",
        "Orlando, FL",
        "Irvine, CA",
        "Toledo, OH",
        "Durham, NC",
        "Chula Vista, CA",
        "Fort Wayne, IN",
        "Jersey City, NJ",
        "St. Petersburg, FL",
        "Laredo, TX",
        "Madison, WI",
        "Chandler, AZ",
        "Buffalo, NY",
        "Lubbock, TX",
        "Scottsdale, AZ",
        "Reno, NV",
        "Glendale, AZ",
        "Gilbert, AZ",
        "Winston-Salem, NC",
        "North Las Vegas, NV",
        "Norfolk, VA",
        "Chesapeake, VA",
        "Garland, TX",
        "Irving, TX",
        "Hialeah, FL",
        "Fremont, CA",
        "Boise, ID",
        "Richmond, VA",
        "Spokane, WA",
        "Baton Rouge, LA",
        "Tacoma, WA",
        "San Bernardino, CA",
        "Modesto, CA",
        "Fontana, CA",
        "Santa Clarita, CA",
        "Des Moines, IA",
        "Birmingham, AL",
        "Rochester, NY",
      ];

      async function loadCities() {
        try {
          const res = await fetch("data/cities.json", { cache: "no-store" });
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data) && data.length) return data;
          }
        } catch {}
        return FALLBACK_CITIES;
      }

      // ========== Utils ==========
      const $ = (s, r = document) => r.querySelector(s);
      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }
      function highlight(txt, term) {
        if (!term) return txt;
        try {
          return txt.replace(
            new RegExp(escapeRegExp(term), "ig"),
            (m) => `<mark>${m}</mark>`
          );
        } catch {
          return txt;
        }
      }
      function toPrettyPath(full) {
        // "New York, NY" -> "/NewYork-NY"
        const [cityRaw, stateRaw = ""] = full.split(",").map((s) => s.trim());
        const strip = (s) =>
          s
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") // strip accents
            .replace(/[^A-Za-z0-9]/g, ""); // remove spaces/punct
        const city = strip(cityRaw); // "NewYork"
        const state = strip(stateRaw); // "NY"
        return `/${city}-${state}`;
      }
      function prefetchCity(name) {
        const l = document.createElement("link");
        l.rel = "prefetch";
        l.as = "document";
        l.href = `/city.html?name=${encodeURIComponent(name)}`;
        document.head.appendChild(l);
      }

      // ========== Search + selection UI ==========
      app.use(({ bus, store }) => {
        const input = $("#citySearch");
        const listEl = $("#results");
        const countEl = $("#resultCount");
        const viewBtn = $("#viewBtn");

        const REMEMBER_KEY = "gw:remember";
        const SELECTED_KEY = "gw:selected";
        const rememberEl = document.getElementById("rememberChoice");

        // Initialize from saved pref
        const remember = localStorage.getItem(REMEMBER_KEY) === "1"; // Storage.getItem
        if (rememberEl) rememberEl.checked = remember; // checkbox.checked

        // Persist preference and clear saved city if turned off
        rememberEl?.addEventListener("change", () => {
          // change event
          const v = rememberEl.checked ? "1" : "0";
          localStorage.setItem(REMEMBER_KEY, v); // Storage.setItem
          if (!rememberEl.checked) localStorage.removeItem(SELECTED_KEY);
        });

        let activeIndex = -1;
        let filtered = [];

        const OPEN_RECLICK_DELAY = 450; // ms
        let lastClick = { idx: -1, t: 0 };

        function render() {
          const q = store.query.trim().toLowerCase();
          filtered = !q
            ? store.cities.slice(0, 200)
            : store.cities.filter((c) => c.toLowerCase().includes(q));
          listEl.innerHTML = filtered
            .map((c, i) => {
              const isActive = i === activeIndex;
              const isSelected =
                store.selectedCity && c === store.selectedCity.name;
              return `
  <div class="option" id="opt-${i}" role="option"
       aria-selected="${isActive || isSelected}" data-idx="${i}">
    <span class="dot" aria-hidden="true">🏙️</span>
    <span class="label">${highlight(c, store.query)}</span>

    <!-- View button now BEFORE the badge -->
    <button class="btn small view-btn" type="button"
            data-idx="${i}" aria-label="View ${c}">View</button>
    <span class="badge">US</span>
  </div>`;
            })
            .join("");

          countEl.textContent = filtered.length
            ? `${filtered.length} result${filtered.length === 1 ? "" : "s"}`
            : "No matches";
          input.setAttribute(
            "aria-activedescendant",
            activeIndex >= 0 ? `opt-${activeIndex}` : ""
          );
        }

        function move(delta) {
          if (!filtered.length) return;
          activeIndex =
            (activeIndex + delta + filtered.length) % filtered.length;
          render();
          const activeEl = document.getElementById(`opt-${activeIndex}`);
          if (activeEl) {
            activeEl.scrollIntoView({ block: "nearest" });
          }
        }

        function selectByIndex(i) {
          const city = filtered[i];
          if (city) {
            activeIndex = i; // keeps highlight in sync for mouse or keyboard
            app.selectCity({ name: city }); // triggers button visibility handler
            render();
          }
        }

        input.addEventListener("input", (e) => {
          activeIndex = -1;
          app.setQuery(e.target.value);
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            move(1);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            move(-1);
          } else if (e.key === "Enter" && activeIndex >= 0) {
            e.preventDefault();
            selectByIndex(activeIndex);
          }
        });
        listEl.addEventListener("click", (e) => {
          // NEW: if the per-row View button was clicked, open immediately
          const vb = e.target.closest(".view-btn");
          if (vb) {
            e.stopPropagation();
            const idx = Number(vb.dataset.idx);
            const city = filtered[idx];
            if (city) {
              // helper
              const goToCity = (name) =>
                (window.location.href = `/city.html?name=${encodeURIComponent(
                  name
                )}`);

              goToCity(city);
            }
            return;
          }
          const opt = e.target.closest(".option");
          if (!opt) return;

          const idx = Number(opt.dataset.idx);
          const now = e.timeStamp || Date.now();

          // True double-click: open immediately
          if (e.detail === 2) {
            const city = filtered[idx];
            if (city) {
              // helper
              const goToCity = (name) =>
                (window.location.href = `/city.html?name=${encodeURIComponent(
                  name
                )}`);

              goToCity(city);
            }
            lastClick = { idx, t: now };
            return;
          }

          // Re-click on the already highlighted city after a short pause: open it
          if (idx === activeIndex && now - lastClick.t > OPEN_RECLICK_DELAY) {
            const city = filtered[idx];
            if (city) {
              // helper
              const goToCity = (name) =>
                (window.location.href = `/city.html?name=${encodeURIComponent(
                  name
                )}`);

              goToCity(city);
            }
            lastClick = { idx, t: now };
            return;
          }

          // Otherwise just select/highlight
          selectByIndex(idx);
          lastClick = { idx, t: now };
        });

        // Show/hide + wire the View button after a selection
        bus.on("city:selected", (city) => {
          if (!viewBtn) return;
          if (city && city.name) {
            prefetchCity(city);
            viewBtn.classList.remove("hidden");
            viewBtn.onclick = () => {
              // helper
              const goToCity = (name) =>
                (window.location.href = `/city.html?name=${encodeURIComponent(
                  name
                )}`);

              goToCity(city.name);
            };
          } else {
            viewBtn.classList.add("hidden");
            viewBtn.onclick = null;
          }
        });

        bus.on("query:changed", render);
        bus.on("cities:loaded", render);
      });

      (function () {
        const p = new URLSearchParams(location.search);
        if (p.has("noredirect")) {
          history.replaceState(null, "", "/");
        } else {
          const remember = localStorage.getItem("gw:remember") === "1";
          const last = JSON.parse(
            localStorage.getItem("gw:selected") || "null"
          );
          if (remember && last?.name) {
            location.href = "/city.html?name=" + encodeURIComponent(last.name);
          }
        }
      })();

      // ========== Boot ==========
      (async function init() {
        const cities = await loadCities();
        app.store.cities = cities;
        app.bus.emit("cities:loaded", cities);
      })();
    </script>
  </body>
</html>
